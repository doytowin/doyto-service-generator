"use strict";genApp.factory("Column",["$resource",function(e){return e("api/column/:id",{id:"@id"})}]).controller("ColumnCtrl",["$scope","Column",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Module",["$resource",function(e){return e("api/module/:id",{id:"@id"},{upload:{url:"api/module/upload/:id",method:"POST"},table:{url:"api/table/:table",method:"GET"},template:{url:"api/template/",method:"GET"}})}]).controller("ModuleCtrl",["$scope","Project","Module","Column",function(e,t,r,o){e.crud=new Crud(r,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)}),t.query(function(t){if(t.success&&(e.projects=t.result,localStorage.projectId))for(var r=0;r<e.projects.length;r++){var o=e.projects[r];if(o.id==localStorage.projectId){e.crud.project=o,e.crud.p.q.projectId=o.id,e.crud.p.load(!0);break}}}),e.sqlResolved=!1,e.resolveSql=function(t){if(/^create\s+table\s+(\w+)\s?/gi.test(t.createSql)){t.tableName=RegExp.$1;var r=Util.camelize(RegExp.$1);t.name=r;var o=Util.capitalize(r);t.modelName=o,t.fullName=o,t.displayName=o,e.sqlResolved=!0}else alert("sql格式错误!")},e.editLabels=function(t){o.query({tableName:t.tableName,projectId:t.projectId},function(r){r.success?(t.columns=r.result,e.crud.record=t):Util.handleFailure(r)})},e.saveLabels=function(e){o.save(e,function(e){e.success?(alert("更新成功"),$(".modal").modal("hide")):Util.handleFailure(e)})}}]),genApp.factory("Project",["$resource",function(e){return e("api/project/:id",{id:"@id"})}]).controller("ProjectCtrl",["$scope","Project",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Template",["$resource",function(e){return e("api/template/:id",{id:"@id"})}]).controller("TemplateCtrl",["$scope","Project","Template","$window",function(e,t,r,o){e.crud=new Crud(r,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):e.errors=Util.handleFailure(t)}),t.query(function(t){if(t.success&&(e.projects=t.result,console.log(e.projects),localStorage.projectId))for(var r=0;r<e.projects.length;r++){var o=e.projects[r];if(o.id==localStorage.projectId){e.crud.project=o,e.crud.p.q.projectId=o.id,e.crud.p.load(!0);break}}}),e.crud.add=function(){this.record={cap:!0}},o.readContent=function(t){var r=t[0],o=new FileReader;o.onload=function(t){e.crud.record.content=t.target.result,e.crud.record.suffix||(e.crud.record.suffix=r.name.replace(/^_\./,".")),e.$apply()},o.readAsText(r)}}]);var Crud=function(e,t,r){function o(e){var t={},r="createTime|createUserId|updateTime|updateUserId|deleted";for(var o in e)e.hasOwnProperty(o)&&r.indexOf(o)<0&&(t[o]=e[o]);return t}var n="访问错误",i=!1,a=function(e){i=!1,"function"==typeof t?t(e):e.success||alert(e.message||n)},s=function(e){i=!1,"function"==typeof r?r(e):"object"==typeof e?alert("Status["+e.status+"]: "+(e.data.message||e.statusText||n)):alert("string"==typeof e?e:n)};this.add=function(){this.record={}},this.edit=function(e){this.record=o(e)},this.view=function(e){this.record=e},this.save=function(t){i||(i=!0,e.save(t,a,s))},this.remove=function(t,r){confirm(r||"确定要删除这条记录吗?")&&e.remove({},{id:t.id},a,s)},this.p=new Page(e.query).load()},Page=function(e){function t(e){if(e.success){if("number"==typeof e.total){a=e.total;var t=Math.ceil(a/n);if(i!==t&&(i=t,o>t))return o=Math.min(t,1),void(this&&this.load());!o&&i&&(o=1);var r=this;r.page=o,r.limit=n,r.pages=i,r.total=a,r.from=Math.max((o-1)*n+1,0),r.to=Math.min(o*n,a),r.result=e.result}}else Util.handleFailure(e)}var r,o=0,n=10,i=0,a=0;this.q={},this.isQueryChanged=function(){return!angular.equals(this.q,r)},this.load=function(i){var a=this.q;if(!i||!angular.equals(this.q,r))return a.page=o||1,a.limit=n,r=angular.copy(a),e(a,angular.bind(this,t)),this},this.first=function(){o>1&&(o=1,this.load())},this.last=function(){o!==i&&(o=i,this.load())},this.prev=function(){o>1&&(o--,this.load())},this.next=function(){o<i&&(o++,this.load())},this.size=function(e){n=e,o=Math.min(o,Math.ceil(a/n)),o=Math.max(o,1),this.load()},this["goto"]=function(e){o=e,this.load()},this.reset=function(){this.q={},o=1,this.load()}},Util=window.Util||{};Util.formHttpRequestTransform=function(e){var t=function(e){var r,o,n,i,a,s,u,c="";for(r in e)if(e.hasOwnProperty(r)&&!r.startsWith("$$"))if(o=e[r],o instanceof Array)for(u=0;u<o.length;++u)a=o[u],n=r+"["+u+"]",s={},s[n]=a,c+=t(s)+"&";else if(o instanceof Object)for(i in o)o.hasOwnProperty(i)&&(a=o[i],n=r+"["+i+"]",s={},s[n]=a,c+=t(s)+"&");else void 0!==o&&null!==o&&(c+=encodeURIComponent(r)+"="+encodeURIComponent(o)+"&");return c.length?c.substr(0,c.length-1):c};return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e},Util.escapeHTML=function(e){return e?e.replace(/[\"'\/<>]/g,function(e){return{'"':"&quot;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"}[e]}):""},Util.capitalize=function(e){return"string"!=typeof e?e:e.charAt(0).toUpperCase()+e.slice(1)},Util.camelize=function(e){return"string"!=typeof e?e:e.replace(/^([A-Z])|[\s\-_](\w)/g,function(e,t,r){return r?r.toUpperCase():t.toLowerCase()})},Util.handleFailure=function(e){if(e&&!e.success){if("1"!==e.code)return alert(e.message||"访问错误"),e.errors;location.href="login?redirect="+encodeURIComponent(location.href)}},genApp.run(["$rootScope",function(e){e.$on("$stateChangeSuccess",function(){angular.forEach(document.querySelectorAll(".modal-backdrop"),function(e){e.parentNode.removeChild(e)})})}]).run(["$rootScope","$state",function(e,t){e.$state=t}]),genApp.config(["$stateProvider","$urlRouterProvider",function(e,t){var r=angular.extend({root:{name:"generator",url:"/"},models:[]},window.Config);angular.forEach(r.models,function(t){var o=t.url,n=t.uri=t.url.split("?")[0],i={name:r.root.name+"."+n,url:o,views:{}};i.views[n]={templateUrl:"res/html/"+n+".html"},t.sticky&&(i.sticky=!0,i.deepStateRedirect=!0),e.state(i)}),e.state(r.root.name,{url:r.root.url,"abstract":!0,template:function(){var e="";return angular.forEach(r.models,function(t){e+='<div ui-view="'+t.uri+'" ng-show="$state.includes(\''+r.root.name+"."+t.uri+"')\"></div>"}),e}}),t.otherwise(r.root.url+r.models[0].url)}]).config(["$resourceProvider",function(e){e.defaults.actions.query.isArray=!1}]).factory("fastjsonInterceptor",[function(){return{response:function(e){return e.data&&"object"==typeof e.data&&restore$ref(e.data),e}}}]).config(["$httpProvider",function(e){e.interceptors.push("fastjsonInterceptor")}]),genApp.directive("gzBindTemplate",["$compile",function(e){return{restrict:"EA",link:function(t,r,o){var n=t.$eval(o.gzBindTemplate);r.html(n),e(r.contents())(t)}}}]),genApp.filter("regex",function(){return function(e,t,r){if(!e||!e.length)return[];var o=[];r=new RegExp(r);for(var n=0;n<e.length;n++)r.test(e[n][t])&&o.push(e[n]);return o}}).filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}}).filter("camelize",function(){return function(e){var t="";if(e){var r=e.split(/[-_.\s]/);t=r[0];for(var o=1;o<r.length;o++)t+=r[o].charAt(0).toUpperCase()+r[o].slice(1)}return t}}).filter("pluralize",function(){function e(e){if("string"!=typeof e)return e;for(var t=[{regex:/octopus/gi,suffix:"octopuses"},{regex:/person/gi,suffix:"people"},{regex:/ox/gi,suffix:"oxen"},{regex:/goose/gi,suffix:"geese"},{regex:/mouse/gi,suffix:"mice"},{regex:/bison|buffalo|deer|duck|fish|moose|pike|plankton|salmon|sheep|squid|swine|trout|sheap|equipment|information|rice|money|species|series|news/i,suffix:"$&"},{regex:/(x|ch|ss|sh)$/gi,suffix:"$1es"},{regex:/(hetero|canto|photo|zero|piano|pro|kimono|portico|quarto)$/gi,suffix:"$1s"},{regex:/(?:([^f])fe|([lr])f)$/,suffix:"$1$2ves"},{regex:/o$/gi,suffix:"oes"},{regex:/([^aeiouy]|qu)y$/gi,suffix:"$1ies"},{regex:/s$/gi,suffix:"s"},{regex:/$/gi,suffix:"s"}],r=0;r<t.length;r++){var o=t[r];if(e.match(o.regex)){e=e.replace(o.regex,o.suffix);break}}return e}return function(t){return t?e(t):t}}),genApp.run(["$rootScope",function(e){e.Math=window.Math,e.Date=window.Date}]).run(["$rootScope","$http",function(e,t){e.loadMenu=function(){t.get("api/menu/tree").success(function(t){e.menuTree=t.result})},e.loadLoginUser=function(){t.get("login-user").success(function(t){t.success?(e.loginUser=t.result,e.loadMenu()):location.href="login?redirect="+encodeURIComponent(location.href)})}}]),genApp.controller("GeneratorCtrl",["$scope","$timeout","$log","Project","Module","Template",function(e,t,r,o,n,i){function a(e){e.success||Util.handleFailure(e)}e.data={},o.query(function(t){if(t.success){e.projects=t.result;var r=e.projects[0];if(localStorage.projectId)for(var o=0;o<e.projects.length;o++){var n=e.projects[o];if(n.id==localStorage.projectId){r=n;break}}e.switchProject(r)}}),e.switchProject=function(t){t=t||{},e.currentProject=t,localStorage.projectId=t.id,i.query({projectId:t.id,valid:!0},function(t){t.success&&(e.templates=t.result)}),n.query({projectId:t.id,valid:!0},function(r){e.project=angular.copy(t),e.projectName=t.name,r.success&&(e.modules=r.result,e.switchModule(e.modules[0]))})},e.switchModule=function(r,o,i){r=r||{},e.gen=angular.copy(r),e.label=r.displayName||r.name,e.data.labelFilter=r.displayName||r.name,r.columns?(e.columns=r.columns,e.imports=r.imports,angular.isArray(o)&&i<o.length&&t(function(){e.upload(r.name,!0),e.switchModule(o[i],o,i+1)},50)):n.table({table:r.tableName||r.name,projectId:r.projectId},function(n){if(n.success){for(var a=n.result,s=[],u=0;u<a.length;u++){var c=a[u];/^(var|text)/.test(c.type)?(c.type="String",c.jdbcType="VARCHAR"):c.type.startsWith("int")?(c.type="Integer",c.jdbcType="INTEGER"):c.type.startsWith("bigint")?(c.type="Long",c.jdbcType="LONG"):c.type.startsWith("smallint")?(c.type="Short",c.jdbcType="INTEGER"):c.type.startsWith("tinyint(1)")||"bit(1)"==c.type?(c.type="Boolean",c.jdbcType="BIT"):c.type.startsWith("tinyint")?(c.type="Byte",c.jdbcType="BIT"):c.type.startsWith("timestamp")||c.type.startsWith("datetime")?(c.type="Date",c.jdbcType="TIMESTAMP",s.indexOf("java.util.Date")<0&&s.push("java.util.Date")):c.type.startsWith("date")?(c.type="Date",c.jdbcType="Date",s.indexOf("java.util.Date")<0&&s.push("java.util.Date")):(c.type="String",c.jdbcType="VARCHAR")}e.columns=r.columns=a,e.imports=r.imports=s,angular.isArray(o)&&i<o.length&&t(function(){e.upload(r.name,!0),e.switchModule(o[i],o,i+1)},50)}})},e.add=function(e){e.id=void 0,n.save(e,a)},e.save=function(e){n.save(e,a)},e.remove=function(e){n.remove({id:e.id},a)},e.upload=function(t,r){for(var o=[],i=e.templates,s=0;s<i.length;s++){var u=i[s];if(r||u.upload){var c=u.cap?Util.capitalize(t):t,l={};l.text=angular.element(document.getElementById("template-"+u.id)).find("pre").text(),l.path=u.path+c+u.suffix,l.key=u.suffix,o.push(l)}}return o.length?void n.upload({id:t},{root:e.project.path,data:o},a):void alert("请选择需要上传的文件!")},e.uploadAll=function(){e.switchModule(e.modules[0],e.modules,1)}}]);var restore$ref=function(){function e(e,t){for(var r=t.split(/[\.\[\]]+/),o=e,n=1,i=r.length;n<i;++n){var a=r[n];""!==a&&(o=isNaN(a)?o[a]:o[parseInt(a)])}return o}function t(t,r,o){var n=r.node,i=n[o].$ref;if("$"==i.substring(0,1))n[o]=e(t,i);else if("@"==i)n[o]=r.node;else if(".."==i.substring(0,2)){for(var a=i.split(/[\/]+/).length;a-- >0;)r=r.parent;n[o]=r.node}else console.log("无法识别的$ref:"+i)}function r(e,o,n){var i=o?o.node[n]:e;if(null!==i&&"object"==typeof i)if(Array.isArray(i))for(var a=0;a<i.length;a++)r(e,{parent:o,node:i},a);else if(i.$ref)t(e,o,n);else for(var s in i)i.hasOwnProperty(s)&&r(e,{parent:o,node:i},s)}return function(){r(arguments[0])}}();