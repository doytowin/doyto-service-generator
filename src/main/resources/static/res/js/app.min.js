"use strict";var Crud=function(r,t,o){var n="访问错误",i=!1;function a(e){i=!1,"function"==typeof t?t(e):e.success||alert(e.message||n)}function c(e){i=!1,"function"==typeof o?o(e):"object"==typeof e?alert("Status["+e.status+"]: "+(e.data.message||e.statusText||n)):alert("string"==typeof e?e:n)}this.add=function(){this.record={}},this.edit=function(e){this.record=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&"createTime|createUserId|updateTime|updateUserId|deleted".indexOf(r)<0&&(t[r]=e[r]);return t}(e)},this.view=function(e){this.record=e},this.save=function(e){i||(i=!0,e.id?r.patch(e,a,c):r.save(e,a,c))},this.remove=function(e,t){confirm(t||"确定要删除这条记录吗?")&&r.remove({},{id:e.id},a,c)},this.p=new Page(r.query).load()},FIRST_PAGE=1,Page=function(r){var o,n=0,i=10,a=0,c=0;function s(e){if(e.success){if("number"==typeof e.data.total){c=e.data.total;var t=Math.ceil(c/i);if(a!==t&&(a=t)<n)return n=Math.min(t,FIRST_PAGE),void(this&&this.load());!n&&a&&(n=FIRST_PAGE);var r=this;r.pageNumber=n,r.pageSize=i,r.pages=a,r.total=c,r.from=Math.max((n-1)*i+1,0),r.to=Math.min(n*i,c),r.data=e.data.list}}else Util.handleFailure(e)}this.q={},this.isQueryChanged=function(){return!angular.equals(this.q,o)},this.load=function(e){var t=this.q;if(!e||!angular.equals(this.q,o))return t.pageSize=i,t.pageNumber=(n||FIRST_PAGE)-1,o=angular.copy(t),r(t,angular.bind(this,s)),this},this.first=function(){FIRST_PAGE<n&&(n=FIRST_PAGE,this.load())},this.last=function(){n!==a&&(n=a,this.load())},this.prev=function(){FIRST_PAGE<n&&(n--,this.load())},this.next=function(){n<a&&(n++,this.load())},this.size=function(e){i=e,n=Math.min(n,Math.ceil(c/i)),n=Math.max(n,FIRST_PAGE),this.load()},this.goto=function(e){n=e,this.load()},this.reset=function(){this.q={},n=FIRST_PAGE,this.load()}},Util=window.Util||{};Util.formHttpRequestTransform=function(e){var s=function(e){var t,r,o,n,i,a,c="";for(t in e)if(e.hasOwnProperty(t)&&!t.startsWith("$$"))if((r=e[t])instanceof Array)for(a=0;a<r.length;++a)n=r[a],(i={})[t+"["+a+"]"]=n,c+=s(i)+"&";else if(r instanceof Object)for(o in r)r.hasOwnProperty(o)&&(n=r[o],(i={})[t+"["+o+"]"]=n,c+=s(i)+"&");else null!=r&&(c+=encodeURIComponent(t)+"="+encodeURIComponent(r)+"&");return c.length?c.substr(0,c.length-1):c};return angular.isObject(e)&&"[object File]"!==String(e)?s(e):e},Util.escapeHTML=function(e){return e?e.replace(/[\"'\/<>]/g,function(e){return{'"':"&quot;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"}[e]}):""},Util.capitalize=function(e){return"string"!=typeof e?e:e.charAt(0).toUpperCase()+e.slice(1)},Util.camelize=function(e){return"string"!=typeof e?e:e.replace(/^([A-Z])|[\s\-_](\w)/g,function(e,t,r){return r?r.toUpperCase():t.toLowerCase()})},Util.handleFailure=function(e){if(e&&!e.success){if("1"!==e.code)return alert(e.message||"访问错误"),e.errors;location.href="login?redirect="+encodeURIComponent(location.href)}},genApp.run(["$rootScope",function(e){e.$on("$stateChangeSuccess",function(){angular.forEach(document.querySelectorAll(".modal-backdrop"),function(e){e.parentNode.removeChild(e)})})}]).run(["$rootScope","$state",function(e,t){e.$state=t}]),genApp.config(["$stateProvider","$urlRouterProvider",function(n,e){var i=angular.extend({root:{name:"generator",url:"/"},models:[]},window.Config);angular.forEach(i.models,function(e){var t=e.url,r=e.uri=e.url.split("?")[0],o={name:i.root.name+"."+r,url:t,views:{}};o.views[r]={templateUrl:"res/html/"+r+".html"},e.sticky&&(o.sticky=!0,o.deepStateRedirect=!0),n.state(o)}),n.state(i.root.name,{url:i.root.url,abstract:!0,template:function(){var t="";return angular.forEach(i.models,function(e){t+='<div ui-view="'+e.uri+'" ng-show="$state.includes(\''+i.root.name+"."+e.uri+"')\"></div>"}),t}}),e.otherwise(i.root.url+i.models[0].url)}]).config(["$resourceProvider",function(e){e.defaults.actions.query.isArray=!1,e.defaults.actions.patch={method:"PATCH"},e.defaults.actions.update={method:"PUT"}}]).factory("fastjsonInterceptor",[function(){return{response:function(e){return e.data&&"object"==typeof e.data&&restore$ref(e.data),e}}}]).config(["$httpProvider",function(e){e.interceptors.push("fastjsonInterceptor")}]),genApp.directive("gzBindTemplate",["$compile",function(n){return{restrict:"EA",link:function(e,t,r){var o=e.$eval(r.gzBindTemplate);t.html(o),n(t.contents())(e)}}}]),genApp.filter("regex",function(){return function(e,t,r){if(!e||!e.length)return[];var o=[];r=new RegExp(r);for(var n=0;n<e.length;n++)r.test(e[n][t])&&o.push(e[n]);return o}}).filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}}).filter("camelize",function(){return function(e){var t="";if(e){var r=e.split(/[-_.\s]/);t=r[0];for(var o=1;o<r.length;o++)t+=r[o].charAt(0).toUpperCase()+r[o].slice(1)}return t}}).filter("pluralize",function(){return function(e){return e?function(e){if("string"!=typeof e)return e;for(var t=[{regex:/octopus/gi,suffix:"octopuses"},{regex:/person/gi,suffix:"people"},{regex:/ox/gi,suffix:"oxen"},{regex:/goose/gi,suffix:"geese"},{regex:/mouse/gi,suffix:"mice"},{regex:/bison|buffalo|deer|duck|fish|moose|pike|plankton|salmon|sheep|squid|swine|trout|sheap|equipment|information|rice|money|species|series|news/i,suffix:"$&"},{regex:/(x|ch|ss|sh)$/gi,suffix:"$1es"},{regex:/(hetero|canto|photo|zero|piano|pro|kimono|portico|quarto)$/gi,suffix:"$1s"},{regex:/(?:([^f])fe|([lr])f)$/,suffix:"$1$2ves"},{regex:/o$/gi,suffix:"oes"},{regex:/([^aeiouy]|qu)y$/gi,suffix:"$1ies"},{regex:/s$/gi,suffix:"s"},{regex:/$/gi,suffix:"s"}],r=0;r<t.length;r++){var o=t[r];if(e.match(o.regex)){e=e.replace(o.regex,o.suffix);break}}return e}(e):e}}),genApp.run(["$rootScope",function(e){e.Math=window.Math,e.Date=window.Date}]).run(["$rootScope","$http",function(t,e){t.loadMenu=function(){e.get("api/menu/tree").success(function(e){t.menuTree=e.data})},t.loadLoginUser=function(){e.get("login-user").success(function(e){e.success?(t.loginUser=e.data,t.loadMenu()):location.href="login?redirect="+encodeURIComponent(location.href)})}}]),genApp.factory("Column",["$resource",function(e){return e("api/column/:id",{id:"@id"},{batch:{url:"api/column/batch",method:"POST"}})}]).controller("ColumnCtrl",["$scope","Column",function(t,e){t.crud=new Crud(e,function(e){e.success?(t.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(e)})}]),genApp.controller("GeneratorCtrl",["$scope","$timeout","$log","Project","Module","Template","Column",function(s,u,e,t,l,r,o){function d(e){e.success||Util.handleFailure(e)}s.data={},t.query(function(e){if(e.success){s.projects=e.data;var t=s.projects[0];if(localStorage.projectId)for(var r=0;r<s.projects.length;r++){var o=s.projects[r];if(o.id==localStorage.projectId){t=o;break}}s.switchProject(t)}}),s.switchProject=function(t){t=t||{},s.currentProject=t,localStorage.projectId=t.id,r.query({projectId:t.id,valid:!0},function(e){e.success&&(s.templates=e.data)}),l.query({projectId:t.id,valid:!0},function(e){s.project=angular.copy(t),s.projectName=t.name,e.success&&(s.modules=e.data,s.switchModule(s.modules[0]))})},s.switchModule=function(i,a,c){i=i||{},s.gen=angular.copy(i),s.label=i.displayName||i.name,s.data.labelFilter=i.displayName||i.name,i.columns?(s.columns=i.columns,s.imports=i.imports,angular.isArray(a)&&c<a.length&&u(function(){s.upload(i.name,!0),s.switchModule(a[c],a,c+1)},50)):o.query({tableName:i.tableName||i.name,projectId:i.projectId},function(e){if(e.success){for(var t=e.data,r=[],o=0;o<t.length;o++){var n=t[o];n.type.startsWith("int")?(n.type="Integer",n.jdbcType="INTEGER"):n.type.startsWith("bigint")?(n.type="Long",n.jdbcType="LONG"):n.type.startsWith("smallint")?(n.type="Short",n.jdbcType="INTEGER"):n.type.startsWith("tinyint(1)")||"bit(1)"===n.type?(n.type="Boolean",n.jdbcType="BIT"):n.type.startsWith("tinyint")?(n.type="Byte",n.jdbcType="BIT"):n.type.startsWith("timestamp")||n.type.startsWith("datetime")?(n.type="Date",n.jdbcType="TIMESTAMP",r.indexOf("java.util.Date")<0&&r.push("java.util.Date")):n.type.startsWith("date")?(n.type="Date",n.jdbcType="Date",r.indexOf("java.util.Date")<0&&r.push("java.util.Date")):(n.type="String",n.jdbcType="VARCHAR")}s.columns=i.columns=t,s.imports=i.imports=r,angular.isArray(a)&&c<a.length&&u(function(){s.upload(i.name,!0),s.switchModule(a[c],a,c+1)},50)}})},s.add=function(e){e.id=void 0,l.save(e,d)},s.save=function(e){l.save(e,d)},s.remove=function(e){l.remove({id:e.id},d)},s.upload=function(e,t){for(var r=[],o=s.templates,n=0;n<o.length;n++){var i=o[n];if(t||i.upload){var a=i.cap?Util.capitalize(e):e,c={};c.text=angular.element(document.getElementById("template-"+i.id)).find("pre").text(),c.path=i.path+a+i.suffix,c.key=i.suffix,r.push(c)}}r.length?l.upload({id:e},{root:s.project.path,data:r},d):alert("请选择需要上传的文件!")},s.uploadAll=function(){s.switchModule(s.modules[0],s.modules,1)}}]),genApp.factory("Module",["$resource",function(e){return e("api/module/:id",{id:"@id"},{upload:{url:"api/module/upload/:id",method:"POST"},import:{url:"api/import/module",method:"POST"},tableName:{url:"api/column/:table",method:"GET"},saveColumns:{url:"api/column/batch",method:"POST"},template:{url:"api/template/",method:"GET"}})}]).controller("ModuleCtrl",["$scope","Project","Module","Column",function(n,e,t,r){n.crud=new Crud(t,function(e){e.success?(n.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(e)}),n.crud.import=t.import,e.query(function(e){if(e.success){var t;for(n.projects={},t=0;t<e.data.length;t++){var r=e.data[t];n.projects[r.id]=r}if(localStorage.projectId)for(t=0;t<n.projects.length;t++){var o=n.projects[t];if(o.id===localStorage.projectId){n.crud.project=o,n.crud.p.q.projectId=o.id,n.crud.p.load(!0);break}}}}),n.sqlResolved=!1,n.resolveSql=function(e){if(/^create\s+table\s+(\w+)\s?/gi.test(e.createSql)){e.tableName=RegExp.$1;var t=Util.camelize(RegExp.$1);e.name=t;var r=Util.capitalize(t);e.modelName=r,e.fullName=r,e.displayName=r,n.sqlResolved=!0}else alert("sql格式错误!")},n.editLabels=function(t){r.query({tableName:t.tableName,projectId:t.projectId},function(e){e.success?(t.columns=e.data,n.crud.record=t):Util.handleFailure(e)})},n.saveLabels=function(e){r.batch(e,function(e){e.success?($(".modal").modal("hide"),alert("更新成功")):Util.handleFailure(e)})}}]),genApp.factory("Project",["$resource",function(e){return e("api/project/:id",{id:"@id"})}]).controller("ProjectCtrl",["$scope","Project",function(t,e){t.crud=new Crud(e,function(e){e.success?(t.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(e)})}]);var restore$ref=function(){function c(e,t,r){var o=t.node,n=o[r].$ref;if("$"==n.substring(0,1))o[r]=function(e,t){for(var r=t.split(/[\.\[\]]+/),o=e,n=1,i=r.length;n<i;++n){var a=r[n];""!==a&&(o=isNaN(a)?o[a]:o[parseInt(a)])}return o}(e,n);else if("@"==n)o[r]=t.node;else if(".."==n.substring(0,2)){for(var i=n.split(/[\/]+/).length;0<i--;)t=t.parent;o[r]=t.node}else console.log("无法识别的$ref:"+n)}return function(){!function e(t,r,o){var n=r?r.node[o]:t;if(null!==n&&"object"==typeof n)if(Array.isArray(n))for(var i=0;i<n.length;i++)e(t,{parent:r,node:n},i);else if(n.$ref)c(t,r,o);else for(var a in n)n.hasOwnProperty(a)&&e(t,{parent:r,node:n},a)}(arguments[0])}}();genApp.factory("Template",["$resource",function(e){return e("api/template/:id",{id:"@id"})}]).controller("TemplateCtrl",["$scope","Project","Template","$window",function(n,e,t,r){n.crud=new Crud(t,function(e){e.success?(n.crud.p.load(),$(".modal").modal("hide")):n.errors=Util.handleFailure(e)}),e.query(function(e){if(e.success){n.projects={};for(var t=0;t<e.data.length;t++){var r=e.data[t];n.projects[r.id]=r}if(console.log(n.projects),localStorage.projectId)for(t=0;t<n.projects.length;t++){var o=n.projects[t];if(o.id===localStorage.projectId){n.crud.project=o,n.crud.p.q.projectId=o.id,n.crud.p.load(!0);break}}}}),n.crud.add=function(){this.record={cap:!0}},r.readContent=function(e){var t=e[0],r=new FileReader;r.onload=function(e){n.crud.record.content=e.target.data,n.crud.record.suffix||(n.crud.record.suffix=t.name.replace(/^_\./,".")),n.$apply()},r.readAsText(t)}}]);