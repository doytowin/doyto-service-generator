"use strict";genApp.factory("Column",["$resource",function(e){return e("api/column/:id",{id:"@id"})}]).controller("ColumnCtrl",["$scope","Column",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Module",["$resource",function(e){return e("api/module/:id",{id:"@id"},{upload:{url:"api/module/upload/:id",method:"POST"},table:{url:"api/module/table/:table",method:"GET"},template:{url:"api/template/",method:"GET"}})}]).controller("ModuleCtrl",["$scope","Project","Module","Column",function(e,t,n,i){t.query(function(t){t.success&&(e.projects=t.result)}),e.crud=new Crud(n,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)}),e.sqlResolved=!1,e.resolveSql=function(t){if(/^create\s+table\s+(\w+)\s?/gi.test(t.createSql)){t.tableName=RegExp.$1;var n=Util.camelize(RegExp.$1);t.name=n;var i=Util.capitalize(n);t.modelName=i,t.fullName=i,t.displayName=i,e.sqlResolved=!0}else alert("sql格式错误!")},e.editLabels=function(t){i.query({tableName:t.tableName},function(n){n.success?(t.columns=n.result,e.crud.record=t):Util.handleFailure(n)})},e.saveLabels=function(e){i.save(e,function(e){e.success?(alert("更新成功"),$(".modal").modal("hide")):Util.handleFailure(e)})}}]),genApp.factory("Project",["$resource",function(e){return e("api/project/:id",{id:"@id"})}]).controller("ProjectCtrl",["$scope","Project",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Template",["$resource",function(e){return e("api/template/:id",{id:"@id"})}]).controller("TemplateCtrl",["$scope","Project","Template","$window",function(e,t,n,i){t.query(function(t){t.success&&(e.projects=t.result)}),e.crud=new Crud(n,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)}),i.readContent=function(t){var n=t[0],i=new FileReader;i.onload=function(t){e.crud.record.content=t.target.result,e.crud.record.suffix||(e.crud.record.suffix=n.name.replace(/^_\./,".")),e.$apply()},i.readAsText(n)}}]);var Crud=function(e,t,n){function i(e){var t={},n="createTime|createUserId|updateTime|updateUserId|deleted";for(var i in e)e.hasOwnProperty(i)&&n.indexOf(i)<0&&(t[i]=e[i]);return t}var r="访问错误",o=!1,a=function(e){o=!1,"function"==typeof t?t(e):e.success||alert(e.message||r)},u=function(e){o=!1,"function"==typeof n?n(e):"object"==typeof e?alert("Status["+e.status+"]: "+(e.data.message||e.statusText||r)):alert("string"==typeof e?e:r)};this.add=function(){this.record={}},this.edit=function(e){this.record=i(e)},this.view=function(e){this.record=e},this.save=function(t){o||(o=!0,e.save(t,a,u))},this.remove=function(t,n){confirm(n||"确定要删除这条记录吗?")&&e.remove({},{id:t.id},a,u)},this.p=new Page(e.query).load()},Page=function(e){function t(e){if(e.success){if("number"==typeof e.total){a=e.total;var t=Math.ceil(a/r);if(o!==t&&(o=t,i>t))return i=Math.min(t,1),void(this&&this.load());!i&&o&&(i=1);var n=this;n.page=i,n.limit=r,n.pages=o,n.total=a,n.from=Math.max((i-1)*r+1,0),n.to=Math.min(i*r,a),n.result=e.result}}else Util.handleFailure(e)}var n,i=0,r=10,o=0,a=0;this.q={},this.isQueryChanged=function(){return!angular.equals(this.q,n)},this.load=function(o){var a=this.q;if(!o||!angular.equals(this.q,n))return a.page=i||1,a.limit=r,n=angular.copy(a),e(a,angular.bind(this,t)),this},this.first=function(){i>1&&(i=1,this.load())},this.last=function(){i!==o&&(i=o,this.load())},this.prev=function(){i>1&&(i--,this.load())},this.next=function(){o>i&&(i++,this.load())},this.size=function(e){r=e,i=Math.min(i,Math.ceil(a/r)),i=Math.max(i,1),this.load()},this["goto"]=function(e){i=e,this.load()},this.reset=function(){this.q={},i=1,this.load()}},Util=window.Util||{};Util.formHttpRequestTransform=function(e){var t=function(e){var n,i,r,o,a,u,c,s="";for(n in e)if(e.hasOwnProperty(n)&&!n.startsWith("$$"))if(i=e[n],i instanceof Array)for(c=0;c<i.length;++c)a=i[c],r=n+"["+c+"]",u={},u[r]=a,s+=t(u)+"&";else if(i instanceof Object)for(o in i)i.hasOwnProperty(o)&&(a=i[o],r=n+"["+o+"]",u={},u[r]=a,s+=t(u)+"&");else void 0!==i&&null!==i&&(s+=encodeURIComponent(n)+"="+encodeURIComponent(i)+"&");return s.length?s.substr(0,s.length-1):s};return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e},Util.escapeHTML=function(e){return e?e.replace(/[\"'\/<>]/g,function(e){return{'"':"&quot;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"}[e]}):""},Util.capitalize=function(e){return"string"!=typeof e?e:e.charAt(0).toUpperCase()+e.slice(1)},Util.camelize=function(e){return"string"!=typeof e?e:e.replace(/^([A-Z])|[\s\-_](\w)/g,function(e,t,n){return n?n.toUpperCase():t.toLowerCase()})},Util.handleFailure=function(e){e&&!e.success&&("0001"===e.code?location.href="login?redirect="+encodeURIComponent(location.href):alert(e.message||"访问错误"))},genApp.run(["$rootScope",function(e){e.$on("$stateChangeSuccess",function(){angular.forEach(document.querySelectorAll(".modal-backdrop"),function(e){e.parentNode.removeChild(e)})})}]).run(["$rootScope","$state",function(e,t){e.$state=t}]),genApp.config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|weixin|wxlocalresource):/)}]).config(["$stateProvider","$urlRouterProvider",function(e,t){var n=angular.extend({base:"app",models:[]},window.Config);angular.forEach(n.models,function(t){var i=t.url,r=t.uri=t.url.split("?")[0],o={name:n.base+"."+r,url:i,views:{}};o.views[r]={templateUrl:"res/html/"+r+".html"},t.sticky&&(o.sticky=!0,o.deepStateRedirect=!0),e.state(o)}),e.state(n.base,{url:"/"+n.base+"/","abstract":!0,template:function(){var e="";return angular.forEach(n.models,function(t){e+='<div ui-view="'+t.uri+'" ng-show="$state.includes(\'app.'+t.uri+"')\"></div>"}),e}}),t.otherwise(n.base+"/"+n.models[0].url)}]).config(["$resourceProvider",function(e){e.defaults.actions.query.isArray=!1}]),genApp.directive("gzBindTemplate",["$compile",function(e){return{restrict:"EA",link:function(t,n,i){var r=t.$eval(i.gzBindTemplate);n.html(r),e(n.contents())(t)}}}]),genApp.filter("regex",function(){return function(e,t,n){if(!e||!e.length)return[];var i=[];n=new RegExp(n);for(var r=0;r<e.length;r++)n.test(e[r][t])&&i.push(e[r]);return i}}).filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}}),genApp.run(["$rootScope",function(e){e.Math=window.Math,e.Date=window.Date}]).run(["$rootScope","$http",function(e,t){e.loadMenu=function(){t.get("api/menu/tree").success(function(t){e.menuTree=t.result})},e.loadLoginUser=function(){t.get("login-user").success(function(t){t.success?(e.loginUser=t.result,e.loadMenu()):location.href="login?redirect="+encodeURIComponent(location.href)})}}]),genApp.controller("GeneratorCtrl",["$scope","Project","Module","Template",function(e,t,n,i){function r(e){e.success||Util.handleFailure(e)}t.query(function(t){t.success&&(e.projects=t.result,e.switchProject(e.projects[0]))}),e.switchProject=function(t){t=t||{},i.query({projectId:t.id},function(t){t.success&&(e.templates=t.result)}),n.query({projectId:t.id},function(n){e.project=angular.copy(t),e.projectName=t.name,n.success&&(e.modules=n.result,e.switchModule(e.modules[0]))})},e.switchModule=function(t){t=t||{},e.gen=angular.copy(t),e.label=t.displayName,t.columns?(e.columns=t.columns,e.imports=t.imports):n.table({table:t.tableName||t.name},function(n){if(n.success){for(var i=n.result,r=[],o=0;o<i.length;o++){var a=i[o];/^(var|text)/.test(a.type)?(a.type="String",a.jdbcType="VARCHAR"):a.type.startsWith("int")?(a.type="Integer",a.jdbcType="INTEGER"):a.type.startsWith("smallint")?(a.type="Short",a.jdbcType="INTEGER"):a.type.startsWith("tinyint")?(a.type="Boolean",a.jdbcType="BIT"):a.type.startsWith("timestamp")||a.type.startsWith("datetime")?(a.type="Date",a.jdbcType="TIMESTAMP",r.indexOf("java.util.Date")<0&&r.push("java.util.Date")):(a.type="String",a.jdbcType="VARCHAR")}e.columns=t.columns=i,e.imports=t.imports=r}})},e.add=function(e){e.id=void 0,n.save(e,r)},e.save=function(e){n.save(e,r)},e.remove=function(e){n.remove({id:e.id},r)},e.upload=function(t,i){for(var o=[],a=e.templates,u=0;u<a.length;u++){var c=a[u];if(i||c.upload){var s=c.cap?Util.capitalize(t):t,l={};l.text=angular.element(document.getElementById("template-"+c.id)).find("pre").text(),l.path=c.path+s+c.suffix,l.key=c.suffix,o.push(l)}}return o.length?void n.upload({id:t},{root:e.project.path,data:o},r):void alert("请选择需要上传的文件!")}}]);