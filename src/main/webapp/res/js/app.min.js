"use strict";genApp.factory("Column",["$resource",function(e){return e("api/column/:id",{id:"@id"})}]).controller("ColumnCtrl",["$scope","Column",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Module",["$resource",function(e){return e("api/module/:id",{id:"@id"},{upload:{url:"api/module/upload/:id",method:"POST"},table:{url:"api/module/table/:table",method:"GET"},template:{url:"api/template/",method:"GET"}})}]).controller("ModuleCtrl",["$scope","Project","Module","Column",function(e,t,n,r){t.query(function(t){t.success&&(e.projects=t.result)}),e.crud=new Crud(n,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)}),e.sqlResolved=!1,e.resolveSql=function(t){if(/^create\s+table\s+(\w+)\s?/gi.test(t.createSql)){t.tableName=RegExp.$1;var n=Util.camelize(RegExp.$1);t.name=n;var r=Util.capitalize(n);t.modelName=r,t.fullName=r,t.displayName=r,e.sqlResolved=!0}else alert("sql格式错误!")},e.editLabels=function(t){r.query({tableName:t.tableName},function(n){n.success?(t.columns=n.result,e.crud.record=t):Util.handleFailure(n)})},e.saveLabels=function(e){r.save(e,function(e){e.success?(alert("更新成功"),$(".modal").modal("hide")):Util.handleFailure(e)})}}]),genApp.factory("Project",["$resource",function(e){return e("api/project/:id",{id:"@id"})}]).controller("ProjectCtrl",["$scope","Project",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Template",["$resource",function(e){return e("api/template/:id",{id:"@id"})}]).controller("TemplateCtrl",["$scope","Project","Template","$window",function(e,t,n,r){t.query(function(t){t.success&&(e.projects=t.result)}),e.crud=new Crud(n,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):e.errors=Util.handleFailure(t)}),e.crud.add=function(){this.record={cap:!0}},r.readContent=function(t){var n=t[0],r=new FileReader;r.onload=function(t){e.crud.record.content=t.target.result,e.crud.record.suffix||(e.crud.record.suffix=n.name.replace(/^_\./,".")),e.$apply()},r.readAsText(n)}}]);var Crud=function(e,t,n){function r(e){var t={},n="createTime|createUserId|updateTime|updateUserId|deleted";for(var r in e)e.hasOwnProperty(r)&&n.indexOf(r)<0&&(t[r]=e[r]);return t}var o="访问错误",i=!1,a=function(e){i=!1,"function"==typeof t?t(e):e.success||alert(e.message||o)},u=function(e){i=!1,"function"==typeof n?n(e):"object"==typeof e?alert("Status["+e.status+"]: "+(e.data.message||e.statusText||o)):alert("string"==typeof e?e:o)};this.add=function(){this.record={}},this.edit=function(e){this.record=r(e)},this.view=function(e){this.record=e},this.save=function(t){i||(i=!0,e.save(t,a,u))},this.remove=function(t,n){confirm(n||"确定要删除这条记录吗?")&&e.remove({},{id:t.id},a,u)},this.p=new Page(e.query).load()},Page=function(e){function t(e){if(e.success){if("number"==typeof e.total){a=e.total;var t=Math.ceil(a/o);if(i!==t&&(i=t,r>t))return r=Math.min(t,1),void(this&&this.load());!r&&i&&(r=1);var n=this;n.page=r,n.limit=o,n.pages=i,n.total=a,n.from=Math.max((r-1)*o+1,0),n.to=Math.min(r*o,a),n.result=e.result}}else Util.handleFailure(e)}var n,r=0,o=10,i=0,a=0;this.q={},this.isQueryChanged=function(){return!angular.equals(this.q,n)},this.load=function(i){var a=this.q;if(!i||!angular.equals(this.q,n))return a.page=r||1,a.limit=o,n=angular.copy(a),e(a,angular.bind(this,t)),this},this.first=function(){r>1&&(r=1,this.load())},this.last=function(){r!==i&&(r=i,this.load())},this.prev=function(){r>1&&(r--,this.load())},this.next=function(){i>r&&(r++,this.load())},this.size=function(e){o=e,r=Math.min(r,Math.ceil(a/o)),r=Math.max(r,1),this.load()},this["goto"]=function(e){r=e,this.load()},this.reset=function(){this.q={},r=1,this.load()}},Util=window.Util||{};Util.formHttpRequestTransform=function(e){var t=function(e){var n,r,o,i,a,u,c,l="";for(n in e)if(e.hasOwnProperty(n)&&!n.startsWith("$$"))if(r=e[n],r instanceof Array)for(c=0;c<r.length;++c)a=r[c],o=n+"["+c+"]",u={},u[o]=a,l+=t(u)+"&";else if(r instanceof Object)for(i in r)r.hasOwnProperty(i)&&(a=r[i],o=n+"["+i+"]",u={},u[o]=a,l+=t(u)+"&");else void 0!==r&&null!==r&&(l+=encodeURIComponent(n)+"="+encodeURIComponent(r)+"&");return l.length?l.substr(0,l.length-1):l};return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e},Util.escapeHTML=function(e){return e?e.replace(/[\"'\/<>]/g,function(e){return{'"':"&quot;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"}[e]}):""},Util.capitalize=function(e){return"string"!=typeof e?e:e.charAt(0).toUpperCase()+e.slice(1)},Util.camelize=function(e){return"string"!=typeof e?e:e.replace(/^([A-Z])|[\s\-_](\w)/g,function(e,t,n){return n?n.toUpperCase():t.toLowerCase()})},Util.handleFailure=function(e){if(e&&!e.success){if("0001"!==e.code)return alert(e.message||"访问错误"),e.errors;location.href="login?redirect="+encodeURIComponent(location.href)}},genApp.run(["$rootScope",function(e){e.$on("$stateChangeSuccess",function(){angular.forEach(document.querySelectorAll(".modal-backdrop"),function(e){e.parentNode.removeChild(e)})})}]).run(["$rootScope","$state",function(e,t){e.$state=t}]),genApp.config(["$stateProvider","$urlRouterProvider",function(e,t){var n=angular.extend({root:{name:"generator",url:"/"},models:[]},window.Config);angular.forEach(n.models,function(t){var r=t.url,o=t.uri=t.url.split("?")[0],i={name:n.root.name+"."+o,url:r,views:{}};i.views[o]={templateUrl:"res/html/"+o+".html"},t.sticky&&(i.sticky=!0,i.deepStateRedirect=!0),e.state(i)}),e.state(n.root.name,{url:n.root.url,"abstract":!0,template:function(){var e="";return angular.forEach(n.models,function(t){e+='<div ui-view="'+t.uri+'" ng-show="$state.includes(\''+n.root.name+"."+t.uri+"')\"></div>"}),e}}),t.otherwise(n.root.url+n.models[0].url)}]).config(["$resourceProvider",function(e){e.defaults.actions.query.isArray=!1}]),genApp.directive("gzBindTemplate",["$compile",function(e){return{restrict:"EA",link:function(t,n,r){var o=t.$eval(r.gzBindTemplate);n.html(o),e(n.contents())(t)}}}]),genApp.filter("regex",function(){return function(e,t,n){if(!e||!e.length)return[];var r=[];n=new RegExp(n);for(var o=0;o<e.length;o++)n.test(e[o][t])&&r.push(e[o]);return r}}).filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}}).filter("camelize",function(){return function(e){var t="";if(e){var n=e.split(/[-_.\s]/);t=n[0];for(var r=1;r<n.length;r++)t+=n[r].charAt(0).toUpperCase()+n[r].slice(1)}return t}}),genApp.run(["$rootScope",function(e){e.Math=window.Math,e.Date=window.Date}]).run(["$rootScope","$http",function(e,t){e.loadMenu=function(){t.get("api/menu/tree").success(function(t){e.menuTree=t.result})},e.loadLoginUser=function(){t.get("login-user").success(function(t){t.success?(e.loginUser=t.result,e.loadMenu()):location.href="login?redirect="+encodeURIComponent(location.href)})}}]),genApp.controller("GeneratorCtrl",["$scope","Project","Module","Template",function(e,t,n,r){function o(e){e.success||Util.handleFailure(e)}t.query(function(t){t.success&&(e.projects=t.result,e.switchProject(e.projects[0]))}),e.switchProject=function(t){t=t||{},r.query({projectId:t.id},function(t){t.success&&(e.templates=t.result)}),n.query({projectId:t.id},function(n){e.project=angular.copy(t),e.projectName=t.name,n.success&&(e.modules=n.result,e.switchModule(e.modules[0]))})},e.switchModule=function(t){t=t||{},e.gen=angular.copy(t),e.label=t.displayName,t.columns?(e.columns=t.columns,e.imports=t.imports):n.table({table:t.tableName||t.name},function(n){if(n.success){for(var r=n.result,o=[],i=0;i<r.length;i++){var a=r[i];/^(var|text)/.test(a.type)?(a.type="String",a.jdbcType="VARCHAR"):a.type.startsWith("int")?(a.type="Integer",a.jdbcType="INTEGER"):a.type.startsWith("smallint")?(a.type="Short",a.jdbcType="INTEGER"):a.type.startsWith("tinyint")?(a.type="Boolean",a.jdbcType="BIT"):a.type.startsWith("timestamp")||a.type.startsWith("datetime")?(a.type="Date",a.jdbcType="TIMESTAMP",o.indexOf("java.util.Date")<0&&o.push("java.util.Date")):(a.type="String",a.jdbcType="VARCHAR")}e.columns=t.columns=r,e.imports=t.imports=o}})},e.add=function(e){e.id=void 0,n.save(e,o)},e.save=function(e){n.save(e,o)},e.remove=function(e){n.remove({id:e.id},o)},e.upload=function(t,r){for(var i=[],a=e.templates,u=0;u<a.length;u++){var c=a[u];if(r||c.upload){var l=c.cap?Util.capitalize(t):t,s={};s.text=angular.element(document.getElementById("template-"+c.id)).find("pre").text(),s.path=c.path+l+c.suffix,s.key=c.suffix,i.push(s)}}return i.length?void n.upload({id:t},{root:e.project.path,data:i},o):void alert("请选择需要上传的文件!")}}]);