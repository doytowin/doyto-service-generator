"use strict";genApp.factory("Column",["$resource",function(e){return e("api/column/:id",{id:"@id"})}]).controller("ColumnCtrl",["$scope","Column",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Module",["$resource",function(e){return e("api/module/:id",{id:"@id"},{upload:{url:"api/module/upload/:id",method:"POST"},table:{url:"api/module/table/:table",method:"GET"},template:{url:"api/template/",method:"GET"}})}]).controller("ModuleCtrl",["$scope","Project","Module","Column",function(e,t,n,i){t.query(function(t){t.success&&(e.projects=t.result)}),e.crud=new Crud(n,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)}),e.saveLabels=function(e){i.save(e,function(e){e.success?(alert("更新成功"),$(".modal").modal("hide")):Util.handleFailure(e)})}}]),genApp.factory("Project",["$resource",function(e){return e("api/project/:id",{id:"@id"})}]).controller("ProjectCtrl",["$scope","Project",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Template",["$resource",function(e){return e("api/template/:id",{id:"@id"})}]).controller("TemplateCtrl",["$scope","Project","Template","$window",function(e,t,n,i){t.query(function(t){t.success&&(e.projects=t.result)}),e.crud=new Crud(n,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)}),i.readContent=function(t){var n=t[0],i=new FileReader;i.onload=function(t){e.crud.record.content=t.target.result,e.crud.record.suffix||(e.crud.record.suffix=n.name.replace(/^_\./,".")),e.$apply()},i.readAsText(n)}}]);var Crud=function(e,t,n){function i(e){var t={},n="createTime|createUserId|updateTime|updateUserId|deleted";for(var i in e)e.hasOwnProperty(i)&&n.indexOf(i)<0&&(t[i]=e[i]);return t}var o="访问错误",r=!1,a=function(e){r=!1,"function"==typeof t?t(e):e.success||alert(e.message||o)},u=function(e){r=!1,"function"==typeof n?n(e):"object"==typeof e?alert("Status["+e.status+"]: "+(e.data.message||e.statusText||o)):alert("string"==typeof e?e:o)};this.add=function(){this.record={}},this.edit=function(e){this.record=i(e)},this.view=function(e){this.record=e},this.save=function(t){r||(r=!0,e.save(t,a,u))},this.remove=function(t,n){confirm(n||"确定要删除这条记录吗?")&&e.remove({},{id:t.id},a,u)},this.p=new Page(e.query).load()},Page=function(e){function t(e){if(e.success){if("number"==typeof e.total){a=e.total;var t=Math.ceil(a/o);if(r!==t&&(r=t,i>t))return i=Math.min(t,1),void(this&&this.load());!i&&r&&(i=1);var n=this;n.page=i,n.limit=o,n.pages=r,n.total=a,n.from=Math.max((i-1)*o+1,0),n.to=Math.min(i*o,a),n.result=e.result}}else Util.handleFailure(e)}var n,i=0,o=10,r=0,a=0;this.q={},this.isQueryChanged=function(){return!angular.equals(this.q,n)},this.load=function(r){var a=this.q;if(!r||!angular.equals(this.q,n))return a.page=i||1,a.limit=o,n=angular.copy(a),e(a,angular.bind(this,t)),this},this.first=function(){i>1&&(i=1,this.load())},this.last=function(){i!==r&&(i=r,this.load())},this.prev=function(){i>1&&(i--,this.load())},this.next=function(){r>i&&(i++,this.load())},this.size=function(e){o=e,i=Math.min(i,Math.ceil(a/o)),i=Math.max(i,1),this.load()},this["goto"]=function(e){i=e,this.load()},this.reset=function(){this.q={},i=1,this.load()}},Util=window.Util||{};Util.formHttpRequestTransform=function(e){var t=function(e){var n,i,o,r,a,u,c,s="";for(n in e)if(e.hasOwnProperty(n)&&!n.startsWith("$$"))if(i=e[n],i instanceof Array)for(c=0;c<i.length;++c)a=i[c],o=n+"["+c+"]",u={},u[o]=a,s+=t(u)+"&";else if(i instanceof Object)for(r in i)i.hasOwnProperty(r)&&(a=i[r],o=n+"["+r+"]",u={},u[o]=a,s+=t(u)+"&");else void 0!==i&&null!==i&&(s+=encodeURIComponent(n)+"="+encodeURIComponent(i)+"&");return s.length?s.substr(0,s.length-1):s};return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e},Util.escapeHTML=function(e){return e?e.replace(/[\"'\/<>]/g,function(e){return{'"':"&quot;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"}[e]}):""},Util.capitalize=function(e){return"string"==typeof e?e.charAt(0).toUpperCase()+e.slice(1):e},Util.handleFailure=function(e){e&&!e.success&&("0001"===e.code?location.href="login?redirect="+encodeURIComponent(location.href):alert(e.message||"访问错误"))},genApp.run(["$rootScope",function(e){e.$on("$stateChangeSuccess",function(){angular.forEach(document.querySelectorAll(".modal-backdrop"),function(e){e.parentNode.removeChild(e)})})}]).run(["$rootScope","$state",function(e,t){e.$state=t}]),genApp.config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|weixin|wxlocalresource):/)}]).config(["$stateProvider","$urlRouterProvider",function(e,t){var n=angular.extend({base:"app",models:[]},window.Config);angular.forEach(n.models,function(t){var i=t.url,o=t.uri=t.url.split("?")[0],r={name:n.base+"."+o,url:i,views:{}};r.views[o]={templateUrl:"res/html/"+o+".html"},t.sticky&&(r.sticky=!0,r.deepStateRedirect=!0),e.state(r)}),e.state(n.base,{url:"/"+n.base+"/","abstract":!0,template:function(){var e="";return angular.forEach(n.models,function(t){e+='<div ui-view="'+t.uri+'" ng-show="$state.includes(\'app.'+t.uri+"')\"></div>"}),e}}),t.otherwise(n.base+"/"+n.models[0].url)}]).config(["$resourceProvider",function(e){e.defaults.actions.query.isArray=!1}]),genApp.directive("gzBindTemplate",["$compile",function(e){return{restrict:"EA",link:function(t,n,i){var o=t.$eval(i.gzBindTemplate);n.html(o),e(n.contents())(t)}}}]),genApp.filter("regex",function(){return function(e,t,n){if(!e||!e.length)return[];var i=[];n=new RegExp(n);for(var o=0;o<e.length;o++)n.test(e[o][t])&&i.push(e[o]);return i}}).filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}}),genApp.run(["$rootScope",function(e){e.Math=window.Math,e.Date=window.Date}]).run(["$rootScope","$http",function(e,t){e.loadMenu=function(){t.get("api/menu/tree").success(function(t){e.menuTree=t.result})},e.loadLoginUser=function(){t.get("login-user").success(function(t){t.success?(e.loginUser=t.result,e.loadMenu()):location.href="login?redirect="+encodeURIComponent(location.href)})}}]),genApp.controller("GeneratorCtrl",["$scope","Project","Module","Template",function(e,t,n,i){function o(e){e.success||Util.handleFailure(e)}t.query(function(t){t.success&&(e.projects=t.result,e.switchProject(e.projects[0]))}),e.switchProject=function(t){t=t||{},i.query({projectId:t.id},function(t){t.success&&(e.templates=t.result)}),n.query({projectId:t.id},function(n){e.project=angular.copy(t),e.projectName=t.name,n.success&&(e.modules=n.result,e.switchModule(e.modules[0]))})},e.switchModule=function(t){t=t||{},e.gen=angular.copy(t),e.label=t.displayName;for(var n=t.columns,i=[],o=0;o<n.length;o++){var r=n[o];/^(var|text)/.test(r.type)?(r.type="String",r.jdbcType="VARCHAR"):r.type.startsWith("int")?(r.type="Integer",r.jdbcType="INTEGER"):r.type.startsWith("smallint")?(r.type="Short",r.jdbcType="INTEGER"):r.type.startsWith("tinyint")?(r.type="Boolean",r.jdbcType="BIT"):r.type.startsWith("timestamp")||r.type.startsWith("datetime")?(r.type="Date",r.jdbcType="TIMESTAMP",i.indexOf("java.util.Date")<0&&i.push("java.util.Date")):(r.type="String",r.jdbcType="VARCHAR")}e.columns=n,e.imports=i},e.add=function(e){e.id=void 0,n.save(e,o)},e.save=function(e){n.save(e,o)},e.remove=function(e){n.remove({id:e.id},o)},e.upload=function(t,i){for(var r=[],a=e.templates,u=0;u<a.length;u++){var c=a[u];if(i||c.upload){var s=c.cap?Util.capitalize(t):t,l={};l.text=angular.element(document.getElementById("template-"+c.id)).find("pre").text(),l.path=c.path+s+c.suffix,l.key=c.suffix,r.push(l)}}return r.length?void n.upload({id:t},{root:e.project.path,data:r},o):void alert("请选择需要上传的文件!")}}]);