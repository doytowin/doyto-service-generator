"use strict";genApp.factory("Column",["$resource",function(e){return e("api/column/:id",{id:"@id"})}]).controller("ColumnCtrl",["$scope","Column",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Module",["$resource",function(e){return e("api/module/:id",{id:"@id"},{upload:{url:"api/module/upload/:id",method:"POST"},table:{url:"api/module/table/:table",method:"GET"},template:{url:"api/template/",method:"GET"}})}]).controller("ModuleCtrl",["$scope","Project","Module","Column",function(e,t,n,r){t.query(function(t){t.success&&(e.projects=t.result)}),e.crud=new Crud(n,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)}),e.sqlResolved=!1,e.resolveSql=function(t){if(/^create\s+table\s+(\w+)\s?/gi.test(t.createSql)){t.tableName=RegExp.$1;var n=Util.camelize(RegExp.$1);t.name=n;var r=Util.capitalize(n);t.modelName=r,t.fullName=r,t.displayName=r,e.sqlResolved=!0}else alert("sql格式错误!")},e.editLabels=function(t){r.query({tableName:t.tableName},function(n){n.success?(t.columns=n.result,e.crud.record=t):Util.handleFailure(n)})},e.saveLabels=function(e){r.save(e,function(e){e.success?(alert("更新成功"),$(".modal").modal("hide")):Util.handleFailure(e)})}}]),genApp.factory("Project",["$resource",function(e){return e("api/project/:id",{id:"@id"})}]).controller("ProjectCtrl",["$scope","Project",function(e,t){e.crud=new Crud(t,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)})}]),genApp.factory("Template",["$resource",function(e){return e("api/template/:id",{id:"@id"})}]).controller("TemplateCtrl",["$scope","Project","Template","$window",function(e,t,n,r){t.query(function(t){t.success&&(e.projects=t.result)}),e.crud=new Crud(n,function(t){t.success?(e.crud.p.load(),$(".modal").modal("hide")):Util.handleFailure(t)}),r.readContent=function(t){var n=t[0],r=new FileReader;r.onload=function(t){e.crud.record.content=t.target.result,e.crud.record.suffix||(e.crud.record.suffix=n.name.replace(/^_\./,".")),e.$apply()},r.readAsText(n)}}]);var Crud=function(e,t,n){function r(e){var t={},n="createTime|createUserId|updateTime|updateUserId|deleted";for(var r in e)e.hasOwnProperty(r)&&n.indexOf(r)<0&&(t[r]=e[r]);return t}var i="访问错误",o=!1,a=function(e){o=!1,"function"==typeof t?t(e):e.success||alert(e.message||i)},u=function(e){o=!1,"function"==typeof n?n(e):"object"==typeof e?alert("Status["+e.status+"]: "+(e.data.message||e.statusText||i)):alert("string"==typeof e?e:i)};this.add=function(){this.record={}},this.edit=function(e){this.record=r(e)},this.view=function(e){this.record=e},this.save=function(t){o||(o=!0,e.save(t,a,u))},this.remove=function(t,n){confirm(n||"确定要删除这条记录吗?")&&e.remove({},{id:t.id},a,u)},this.p=new Page(e.query).load()},Page=function(e){function t(e){if(e.success){if("number"==typeof e.total){a=e.total;var t=Math.ceil(a/i);if(o!==t&&(o=t,r>t))return r=Math.min(t,1),void(this&&this.load());!r&&o&&(r=1);var n=this;n.page=r,n.limit=i,n.pages=o,n.total=a,n.from=Math.max((r-1)*i+1,0),n.to=Math.min(r*i,a),n.result=e.result}}else Util.handleFailure(e)}var n,r=0,i=10,o=0,a=0;this.q={},this.isQueryChanged=function(){return!angular.equals(this.q,n)},this.load=function(o){var a=this.q;if(!o||!angular.equals(this.q,n))return a.page=r||1,a.limit=i,n=angular.copy(a),e(a,angular.bind(this,t)),this},this.first=function(){r>1&&(r=1,this.load())},this.last=function(){r!==o&&(r=o,this.load())},this.prev=function(){r>1&&(r--,this.load())},this.next=function(){o>r&&(r++,this.load())},this.size=function(e){i=e,r=Math.min(r,Math.ceil(a/i)),r=Math.max(r,1),this.load()},this["goto"]=function(e){r=e,this.load()},this.reset=function(){this.q={},r=1,this.load()}},Util=window.Util||{};Util.formHttpRequestTransform=function(e){var t=function(e){var n,r,i,o,a,u,c,l="";for(n in e)if(e.hasOwnProperty(n)&&!n.startsWith("$$"))if(r=e[n],r instanceof Array)for(c=0;c<r.length;++c)a=r[c],i=n+"["+c+"]",u={},u[i]=a,l+=t(u)+"&";else if(r instanceof Object)for(o in r)r.hasOwnProperty(o)&&(a=r[o],i=n+"["+o+"]",u={},u[i]=a,l+=t(u)+"&");else void 0!==r&&null!==r&&(l+=encodeURIComponent(n)+"="+encodeURIComponent(r)+"&");return l.length?l.substr(0,l.length-1):l};return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e},Util.escapeHTML=function(e){return e?e.replace(/[\"'\/<>]/g,function(e){return{'"':"&quot;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"}[e]}):""},Util.capitalize=function(e){return"string"!=typeof e?e:e.charAt(0).toUpperCase()+e.slice(1)},Util.camelize=function(e){return"string"!=typeof e?e:e.replace(/^([A-Z])|[\s\-_](\w)/g,function(e,t,n,r){return n?n.toUpperCase():t.toLowerCase()})},Util.handleFailure=function(e){e&&!e.success&&("0001"===e.code?location.href="login?redirect="+encodeURIComponent(location.href):alert(e.message||"访问错误"))},genApp.run(["$rootScope",function(e){e.$on("$stateChangeSuccess",function(){angular.forEach(document.querySelectorAll(".modal-backdrop"),function(e){e.parentNode.removeChild(e)})})}]).run(["$rootScope","$state",function(e,t){e.$state=t}]),genApp.config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|weixin|wxlocalresource):/)}]).config(["$stateProvider","$urlRouterProvider",function(e,t){var n=angular.extend({base:"app",models:[]},window.Config);angular.forEach(n.models,function(t){var r=t.url,i=t.uri=t.url.split("?")[0],o={name:n.base+"."+i,url:r,views:{}};o.views[i]={templateUrl:"res/html/"+i+".html"},t.sticky&&(o.sticky=!0,o.deepStateRedirect=!0),e.state(o)}),e.state(n.base,{url:"/"+n.base+"/","abstract":!0,template:function(){var e="";return angular.forEach(n.models,function(t){e+='<div ui-view="'+t.uri+'" ng-show="$state.includes(\'app.'+t.uri+"')\"></div>"}),e}}),t.otherwise(n.base+"/"+n.models[0].url)}]).config(["$resourceProvider",function(e){e.defaults.actions.query.isArray=!1}]),genApp.directive("gzBindTemplate",["$compile",function(e){return{restrict:"EA",link:function(t,n,r){var i=t.$eval(r.gzBindTemplate);n.html(i),e(n.contents())(t)}}}]),genApp.filter("regex",function(){return function(e,t,n){if(!e||!e.length)return[];var r=[];n=new RegExp(n);for(var i=0;i<e.length;i++)n.test(e[i][t])&&r.push(e[i]);return r}}).filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}}),genApp.run(["$rootScope",function(e){e.Math=window.Math,e.Date=window.Date}]).run(["$rootScope","$http",function(e,t){e.loadMenu=function(){t.get("api/menu/tree").success(function(t){e.menuTree=t.result})},e.loadLoginUser=function(){t.get("login-user").success(function(t){t.success?(e.loginUser=t.result,e.loadMenu()):location.href="login?redirect="+encodeURIComponent(location.href)})}}]),genApp.controller("GeneratorCtrl",["$scope","Project","Module","Template",function(e,t,n,r){function i(e){e.success||Util.handleFailure(e)}t.query(function(t){t.success&&(e.projects=t.result,e.switchProject(e.projects[0]))}),e.switchProject=function(t){t=t||{},r.query({projectId:t.id},function(t){t.success&&(e.templates=t.result)}),n.query({projectId:t.id},function(n){e.project=angular.copy(t),e.projectName=t.name,n.success&&(e.modules=n.result,e.switchModule(e.modules[0]))})},e.switchModule=function(t){t=t||{},e.gen=angular.copy(t),e.label=t.displayName;for(var n=t.columns,r=[],i=0;i<n.length;i++){var o=n[i];/^(var|text)/.test(o.type)?(o.type="String",o.jdbcType="VARCHAR"):o.type.startsWith("int")?(o.type="Integer",o.jdbcType="INTEGER"):o.type.startsWith("smallint")?(o.type="Short",o.jdbcType="INTEGER"):o.type.startsWith("tinyint")?(o.type="Boolean",o.jdbcType="BIT"):o.type.startsWith("timestamp")||o.type.startsWith("datetime")?(o.type="Date",o.jdbcType="TIMESTAMP",r.indexOf("java.util.Date")<0&&r.push("java.util.Date")):(o.type="String",o.jdbcType="VARCHAR")}e.columns=n,e.imports=r},e.add=function(e){e.id=void 0,n.save(e,i)},e.save=function(e){n.save(e,i)},e.remove=function(e){n.remove({id:e.id},i)},e.upload=function(t,r){for(var o=[],a=e.templates,u=0;u<a.length;u++){var c=a[u];if(r||c.upload){var l=c.cap?Util.capitalize(t):t,s={};s.text=angular.element(document.getElementById("template-"+c.id)).find("pre").text(),s.path=c.path+l+c.suffix,s.key=c.suffix,o.push(s)}}return o.length?void n.upload({id:t},{root:e.project.path,data:o},i):void alert("请选择需要上传的文件!")}}]);